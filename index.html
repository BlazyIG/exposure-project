<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>PROJECT: EXPOSURE // IOS FIX</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;800&family=Rajdhani:wght@500;700;900&display=swap" rel="stylesheet">

    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/control_utils/control_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/holistic/holistic.js" crossorigin="anonymous"></script>

    <style>
        :root {
            --neon-red: #ff003c;
            --neon-cyan: #00f3ff;
            --neon-green: #0aff0a;
            --glass: rgba(0, 0, 0, 0.6);
            --font-display: 'Rajdhani', sans-serif;
            --font-code: 'JetBrains Mono', monospace;
        }

        /* RESET TOTAL PARA EVITAR SCROLL */
        html, body {
            margin: 0; padding: 0;
            width: 100%; 
            height: 100%; 
            height: 100dvh; /* Altura dinámica real del iPhone */
            overflow: hidden; /* Bloquea el scroll elástico de Safari */
            background-color: #000;
            font-family: var(--font-code);
            color: var(--neon-cyan);
            -webkit-user-select: none; user-select: none;
            position: fixed; /* Fija el body para que no se mueva */
        }

        /* --- VIDEO LAYER (FONDO) --- */
        #viewport {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 1;
        }
        .input_video { display: none; }
        .output_canvas {
            width: 100%; height: 100%; object-fit: cover; transform: scaleX(-1);
        }
        .scanlines {
            position: absolute; top:0; left:0; width:100%; height:100%; z-index: 2;
            background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.25) 50%);
            background-size: 100% 4px; pointer-events: none;
        }

        /* --- UI LAYER (FLEXBOX) --- */
        /* Esta es la clave: Usamos Flexbox para distribuir el espacio verticalmente */
        #ui-container {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 10;
            display: flex;
            flex-direction: column;
            justify-content: space-between; /* Empuja cabecera arriba y footer abajo */
            padding: 15px;
            /* Respetar el 'Notch' y la barra inferior del iPhone */
            padding-top: env(safe-area-inset-top, 20px);
            padding-bottom: env(safe-area-inset-bottom, 20px);
            pointer-events: none; /* Dejar pasar clicks al canvas si es necesario */
        }

        /* SECCIÓN SUPERIOR */
        .ui-top {
            pointer-events: auto;
            width: 100%;
        }
        .header-row { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 15px; }
        h1 { margin: 0; font-family: var(--font-display); font-size: 1.5rem; line-height: 1; color: #fff; text-shadow: 0 0 10px var(--neon-cyan); }
        .badge { border: 1px solid var(--neon-cyan); padding: 2px 6px; font-size: 0.7rem; color: var(--neon-cyan); }

        .threat-box { margin-bottom: 10px; }
        .threat-label { font-family: var(--font-display); font-size: 0.9rem; color: #fff; margin-bottom: 2px; }
        .bar-bg { width: 100%; height: 6px; background: rgba(255,255,255,0.2); }
        .bar-fill { height: 100%; width: 0%; background: var(--neon-red); transition: width 0.3s; box-shadow: 0 0 8px var(--neon-red); }

        .data-panel { font-size: 0.7rem; background: rgba(0,0,0,0.5); padding: 5px; border-left: 2px solid var(--neon-cyan); margin-bottom: 4px; width: fit-content; }

        /* SECCIÓN INFERIOR (BOTÓN) */
        .ui-bottom {
            pointer-events: auto; /* IMPORTANTE: Reactivar clicks aquí */
            width: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
            /* Margen de seguridad extra para que no pegue con la barra de navegación */
            margin-bottom: 20px; 
        }

        #forbidden-btn {
            background: rgba(255, 0, 60, 0.15);
            border: 2px solid var(--neon-red);
            color: var(--neon-red);
            padding: 20px 0; /* Altura generosa */
            width: 100%; 
            font-family: var(--font-display);
            font-size: 1.2rem;
            font-weight: 700;
            letter-spacing: 2px;
            text-transform: uppercase;
            box-shadow: 0 0 25px rgba(255, 0, 60, 0.4);
            backdrop-filter: blur(4px);
            text-align: center;
            /* Fix para iOS tap highlight */
            -webkit-tap-highlight-color: transparent; 
        }
        #forbidden-btn:active { background: var(--neon-red); color: #000; }
        .btn-small { font-size: 0.65rem; font-weight: normal; opacity: 0.8; display: block; margin-top: 5px; font-family: var(--font-code); }

        .footer-info { font-size: 0.6rem; color: #888; text-align: center; }

        /* --- MATRIX & RESULT LAYERS --- */
        #matrix-layer, #result-layer, #truth-layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; 
            z-index: 50; display: none; background: #000;
        }
        #matrix-layer { z-index: 50; }
        #result-layer { z-index: 60; background: rgba(5,5,5,0.98); padding: 20px; flex-direction: column; justify-content: center; align-items: center; overflow-y: auto; }
        #truth-layer { z-index: 70; padding: 30px; flex-direction: column; justify-content: center; align-items: center; text-align: center; }

        #system-msg {
            position: absolute; top: 40%; left: 50%; transform: translate(-50%, -50%);
            width: 80%; text-align: center; color: var(--neon-green); font-size: 1.2rem;
            border: 1px solid var(--neon-green); padding: 15px; background: rgba(0,0,0,0.8);
        }

        #captured-image { width: 80%; max-width: 350px; border: 2px solid var(--neon-red); margin-bottom: 20px; filter: grayscale(1) contrast(1.2); }
        .res-text { text-align: center; margin-bottom: 15px; }
        .res-big { font-size: 1.2rem; color: #fff; display: block; }
        .res-lbl { font-size: 0.7rem; color: #666; letter-spacing: 2px; }

        .btn-action { background: transparent; border: 1px solid #fff; color: #fff; padding: 15px 30px; margin-top: 10px; font-family: var(--font-display); font-size: 1rem; }
    </style>
</head>
<body>

    <div id="viewport">
        <video class="input_video" playsinline webkit-playsinline></video>
        <canvas class="output_canvas" id="main-canvas"></canvas>
    </div>
    <div class="scanlines"></div>

    <div id="ui-container">
        
        <div class="ui-top">
            <div class="header-row">
                <div>
                    <h1>EXPOSURE</h1>
                    <div style="font-size:0.6rem; opacity:0.7;">IOS SURVEILLANCE V.X</div>
                </div>
                <div class="badge" id="status-badge">INIT...</div>
            </div>

            <div class="threat-box">
                <div class="threat-label">THREAT LEVEL</div>
                <div class="bar-bg"><div class="bar-fill" id="threat-bar"></div></div>
            </div>

            <div class="data-panel">FACE: <span id="face-val" style="color:#fff">SCANNING</span></div>
            <div class="data-panel">HANDS: <span id="hand-val" style="color:#fff">SCANNING</span></div>
            <div class="data-panel">GPS: <span id="gps-val">--.--, --.--</span></div>
        </div>

        <div class="ui-bottom">
            <button id="forbidden-btn" onclick="startSequence()">
                DO NOT PRESS
                <span class="btn-small">IF YOU DON'T WANT TO BE EXPOSED</span>
            </button>
            <div class="footer-info">
                <span id="os-info">IOS KERNEL</span> // <span id="clock">00:00</span>
            </div>
        </div>

    </div>

    <div id="matrix-layer">
        <canvas id="matrix-c"></canvas>
        <div id="system-msg">ACCESSING KERNEL...</div>
    </div>

    <div id="result-layer" style="display:none; display:flex;"> <h2 style="color:var(--neon-red); font-family:var(--font-display); font-size:2rem; margin-bottom:10px;">EXPOSED</h2>
        <img id="captured-image" src="">
        
        <div class="res-text">
            <span class="res-lbl">LOCATION</span>
            <span class="res-big" id="final-loc">UNKNOWN</span>
        </div>
        <div class="res-text">
            <span class="res-lbl">COORDINATES</span>
            <span class="res-big" id="final-gps" style="font-size:0.9rem; color:var(--neon-cyan)">--</span>
        </div>

        <button class="btn-action" onclick="showTruth()">REVEAL TRUTH</button>
    </div>

    <div id="truth-layer" style="display:none; display:flex;">
        <h2 style="color:var(--neon-green); margin-bottom:20px;">SIMULATION ENDED</h2>
        <p style="color:#ccc; line-height:1.5;">
            Por suerte, <b>todo esto es local</b>.<br><br>
            Tus datos no han salido de tu iPhone. Esta demo muestra lo fácil que es obtener tu perfil en tiempo real si aceptas los permisos equivocados.
        </p>
        <div style="margin-top:30px; font-family:var(--font-display); font-size:1.5rem; color:var(--neon-cyan);">DomiStudios</div>
        <button class="btn-action" style="background:#222; border:none; margin-top:30px;" onclick="location.reload()">REBOOT</button>
    </div>

    <script>
        // CONFIG
        const state = { city: "UNKNOWN", lat: "00.00", lon: "00.00", tracking: true, threat: 0, lastNose: {x:0, y:0} };

        // AUDIO
        const AudioSys = {
            ctx: null,
            init: () => { AudioSys.ctx = new (window.AudioContext || window.webkitAudioContext)(); },
            play: (freq, type, dur) => {
                if(!AudioSys.ctx) AudioSys.init();
                const o = AudioSys.ctx.createOscillator();
                const g = AudioSys.ctx.createGain();
                o.type = type; o.frequency.value = freq;
                g.gain.value = 0.1; g.gain.exponentialRampToValueAtTime(0.01, AudioSys.ctx.currentTime + dur);
                o.connect(g); g.connect(AudioSys.ctx.destination);
                o.start(); o.stop(AudioSys.ctx.currentTime + dur);
            },
            glitch: () => { AudioSys.play(50, 'sawtooth', 0.5); setTimeout(()=>AudioSys.play(800,'square',0.1),100); }
        };

        // UI & GEO
        function initUI() {
            // Reloj
            setInterval(() => document.getElementById('clock').innerText = new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}), 1000);
            
            // Geo
            if(navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(async (pos) => {
                    state.lat = pos.coords.latitude.toFixed(4);
                    state.lon = pos.coords.longitude.toFixed(4);
                    document.getElementById('gps-val').innerText = `${state.lat}, ${state.lon}`;
                    try {
                        const r = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${state.lat}&lon=${state.lon}`);
                        const d = await r.json();
                        if(d.address) state.city = (d.address.city || d.address.town || d.address.village || "UNKNOWN").toUpperCase();
                    } catch(e){}
                });
            }
        }

        // VISION ENGINE
        const video = document.querySelector('.input_video');
        const canvas = document.getElementById('main-canvas');
        const ctx = canvas.getContext('2d');

        function onResults(results) {
            // Ajuste forzado al tamaño de la ventana
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
            
            ctx.save();
            ctx.clearRect(0,0,canvas.width,canvas.height);
            
            // Dibujar video "cover" (llenar pantalla)
            const vW = video.videoWidth, vH = video.videoHeight;
            const sW = canvas.width, sH = canvas.height;
            const scale = Math.max(sW/vW, sH/vH);
            const x = (sW - (vW*scale))/2, y = (sH - (vH*scale))/2;
            ctx.drawImage(results.image, x, y, vW*scale, vH*scale);
            
            // Filtro oscuro
            ctx.fillStyle = "rgba(0,10,15,0.4)";
            ctx.fillRect(0,0,sW,sH);

            if(state.tracking) {
                // Manos
                if(results.leftHandLandmarks || results.rightHandLandmarks) {
                    document.getElementById('hand-val').innerText = "LOCKED";
                    document.getElementById('hand-val').style.color = "#00f3ff";
                    drawH(results.leftHandLandmarks); drawH(results.rightHandLandmarks);
                } else {
                    document.getElementById('hand-val').innerText = "SCANNING";
                    document.getElementById('hand-val').style.color = "#fff";
                }
                
                // Cara
                if(results.faceLandmarks) {
                    document.getElementById('face-val').innerText = "ID VERIFIED";
                    document.getElementById('face-val').style.color = "#00f3ff";
                    drawConnectors(ctx, results.faceLandmarks, FACEMESH_FACE_OVAL, {color:'rgba(0,243,255,0.5)', lineWidth:1});
                    calcThreat(results.faceLandmarks[1]);
                } else {
                    document.getElementById('face-val').innerText = "SCANNING";
                    document.getElementById('face-val').style.color = "#fff";
                    calcThreat(null);
                }
            }
            ctx.restore();
        }

        function drawH(l) {
            if(!l) return;
            drawConnectors(ctx, l, HAND_CONNECTIONS, {color:'rgba(0,243,255,0.3)', lineWidth:2});
            drawLandmarks(ctx, l, {color:'#00f3ff', lineWidth:1, radius:2});
        }

        function calcThreat(nose) {
            let move = 0;
            if(nose) {
                let d = Math.sqrt(Math.pow(nose.x - state.lastNose.x, 2) + Math.pow(nose.y - state.lastNose.y, 2));
                move = d * 100;
                state.lastNose = {x: nose.x, y: nose.y};
            }
            if(move > 0.5) state.threat += 2; else state.threat -= 1;
            if(state.threat < 0) state.threat = 0; if(state.threat > 100) state.threat = 100;
            document.getElementById('threat-bar').style.width = state.threat + "%";
        }

        // SEQUENCIA
        let mInt;
        function startSequence() {
            AudioSys.init();
            AudioSys.play(200, 'triangle', 0.2);
            document.getElementById('ui-container').style.display = 'none'; // Ocultar UI normal
            
            const mLayer = document.getElementById('matrix-layer');
            mLayer.style.display = 'block';
            
            // Matrix Effect
            const mc = document.getElementById('matrix-c');
            const mctx = mc.getContext('2d');
            mc.width = window.innerWidth; mc.height = window.innerHeight;
            const cols = Math.floor(mc.width/14);
            const drops = Array(cols).fill(1);
            
            mInt = setInterval(() => {
                mctx.fillStyle = "rgba(0,0,0,0.1)"; mctx.fillRect(0,0,mc.width,mc.height);
                mctx.fillStyle = "#0f0"; mctx.font = "14px monospace";
                drops.forEach((y, i) => {
                    mctx.fillText(String.fromCharCode(0x30A0 + Math.random()*96), i*14, y*14);
                    if(y*14 > mc.height && Math.random()>0.975) drops[i]=0;
                    drops[i]++;
                });
            }, 50);

            // Mensajes
            const msgs = ["BYPASSING FIREWALL...", "ACCESSING CAMERA...", "GPS TRIANGULATION...", "TARGET CONFIRMED."];
            let i = 0;
            const tInt = setInterval(() => {
                if(i < msgs.length) {
                    document.getElementById('system-msg').innerText = msgs[i];
                    AudioSys.play(300 + (i*100), 'square', 0.1);
                    i++;
                } else {
                    clearInterval(tInt);
                    showResult();
                }
            }, 1000);
        }

        function showResult() {
            clearInterval(mInt);
            AudioSys.glitch();
            
            const url = canvas.toDataURL('image/png');
            document.getElementById('captured-image').src = url;
            
            document.getElementById('matrix-layer').style.display = 'none';
            
            const res = document.getElementById('result-layer');
            res.style.display = 'flex'; // Forzar display flex para centrar
            
            document.getElementById('final-loc').innerText = state.city;
            document.getElementById('final-gps').innerText = `${state.lat}, ${state.lon}`;
        }

        function showTruth() {
            document.getElementById('result-layer').style.display = 'none';
            document.getElementById('truth-layer').style.display = 'flex';
        }

        // INIT
        initUI();
        document.getElementById('result-layer').style.display = 'none'; // Asegurar oculto al inicio
        document.getElementById('truth-layer').style.display = 'none';

        const holistic = new Holistic({locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/holistic/${file}`});
        holistic.setOptions({modelComplexity: 0, smoothLandmarks: true, enableSegmentation: false, refineFaceLandmarks: false});
        holistic.onResults(onResults);

        const cam = new Camera(video, {
            onFrame: async () => { await holistic.send({image: video}); },
            width: 1280, height: 720
        });
        cam.start().then(()=> document.getElementById('status-badge').innerText="ONLINE");

    </script>
</body>
</html>
